<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Tracker LIFF App</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #cc1e0f;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #e9e2d0;
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #e9e2d0;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9e2d0;
            border-radius: 10px;
            background: rgba(233, 226, 208, 0.2);
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            background: rgba(233, 226, 208, 0.4);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .camera-section {
            text-align: center;
            margin: 20px 0;
        }

        .file-input {
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #e9e2d0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .food-info {
            background: rgba(233, 226, 208, 0.1);
            border: 1px solid #e9e2d0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .food-name {
            font-size: 22px;
            font-weight: bold;
            color: #e9e2d0;
            margin-bottom: 15px;
            text-align: center;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .nutrition-item {
            background: rgba(204, 30, 15, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9e2d0;
        }

        .nutrition-label {
            font-size: 12px;
            color: #e9e2d0;
            margin-bottom: 5px;
        }

        .nutrition-value {
            font-size: 16px;
            font-weight: bold;
        }

        .tip-section {
            background: rgba(233, 226, 208, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e9e2d0;
        }

        .tip-label {
            font-size: 14px;
            color: #e9e2d0;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .tip-text {
            font-size: 14px;
            line-height: 1.4;
        }

        .question-section {
            text-align: center;
            margin: 30px 0 20px 0;
            padding: 20px;
            background: rgba(233, 226, 208, 0.1);
            border-radius: 10px;
            border: 1px solid #e9e2d0;
        }

        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            color: #e9e2d0;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-yes {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .btn-no {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
        }

        .success-message {
            text-align: center;
            padding: 30px;
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
            border-radius: 15px;
            margin: 20px 0;
        }

        .success-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #e9e2d0;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .image-quality-note {
            background: rgba(233, 226, 208, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            color: #e9e2d0;
            text-align: center;
            border: 1px solid #e9e2d0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
        <div id="homeScreen">
            <div class="header">
                <h1>üçΩÔ∏è Food Tracker</h1>
                <p>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                <div id="connectionStatus" style="font-size: 12px; margin-top: 10px; padding: 8px; background: rgba(233, 226, 208, 0.2); border-radius: 5px;">
                    üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
                </div>
            </div>
            <button class="btn" onclick="openCamera()">
                üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            </button>
        </div>

        <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ -->
        <div id="cameraScreen" class="hidden">
            <div class="header">
                <h1>üì∏ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</p>
            </div>
            <div class="camera-section">
                <input type="file" id="cameraInput" class="file-input" accept="image/*" capture="camera" onchange="handleImageCapture(event)">
                <button class="btn" onclick="document.getElementById('cameraInput').click()">
                    üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á
                </button>
                <input type="file" id="galleryInput" class="file-input" accept="image/*" onchange="handleImageCapture(event)">
                <button class="btn" onclick="document.getElementById('galleryInput').click()">
                    üñºÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà
                </button>
                <button class="btn" onclick="goHome()">
                    ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                </button>
            </div>
        </div>

        <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏π‡∏õ -->
        <div id="confirmScreen" class="hidden">
            <div class="header">
                <h1>üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ</h1>
                <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</p>
            </div>
            <div class="camera-section">
                <div class="image-preview-container">
                    <img id="confirmImage" class="preview-image" alt="Confirm Image">
                </div>
                <div class="image-quality-note">
                    üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏î‡∏µ
                </div>
                <div class="question-section">
                    <div class="question-text">‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏°?</div>
                    <div class="action-buttons">
                        <button class="btn btn-yes" onclick="confirmAndSubmit()">
                            ‚úÖ ‡πÉ‡∏ä‡πà ‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢
                        </button>
                        <button class="btn btn-no" onclick="retakePhoto()">
                            üì∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
        <div id="resultScreen" class="hidden">
            <div class="header">
                <h1>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>
            </div>
            <div id="foodInfo" class="food-info">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
            <div class="question-section">
                <div class="question-text">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏´‡∏°?</div>
                <div class="action-buttons">
                    <button class="btn btn-yes" onclick="saveToLog()">
                        ‚úÖ ‡πÉ‡∏ä‡πà
                    </button>
                    <button class="btn btn-no" onclick="goHome()">
                        ‚ùå ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            </div>
        </div>

        <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
        <div id="successScreen" class="hidden">
            <div class="success-message">
                <div class="success-icon">üéâ</div>
                <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</p>
                <button class="btn" onclick="goHome()" style="margin-top: 20px;">
                    üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingScreen" class="hidden">
            <div class="loading">
                <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message hidden">
            <p id="errorText"></p>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://lvtdqeerzxpznnayccmb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dGRxZWVyenhwem5uYXljY21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0MTAxMjksImV4cCI6MjA2ODk4NjEyOX0.Uai-3_YSJpsYmSSTbHtrSNBoCG5f8WxoUcqyvcV3yUM';
        let supabase = null;

        // Global variables
        let currentUserId = null;
        let currentFoodData = null;
        let capturedImageFile = null;
        let isSupabaseConnected = false;
        let isLiffConnected = false;

        // Initialize Supabase (if credentials are provided)
        function initializeSupabase() {
            try {
                if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    isSupabaseConnected = true;
                    console.log('Supabase connected successfully');
                } else {
                    console.log('Supabase not configured - using demo mode');
                }
            } catch (error) {
                console.error('Supabase initialization failed:', error);
                isSupabaseConnected = false;
            }
            updateConnectionStatus();
        }

        // Update connection status display
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            let statusText = '';
            
            if (isLiffConnected && isSupabaseConnected) {
                statusText = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÅ‡∏•‡∏∞ Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            } else if (isLiffConnected && !isSupabaseConnected) {
                statusText = '‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à | Supabase: ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö';
            } else if (!isLiffConnected && isSupabaseConnected) {
                statusText = '‚ö†Ô∏è LINE: ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö | ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            } else {
                statusText = 'üîß ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE/Supabase)';
            }
            
            statusDiv.textContent = statusText;
        }

        // Initialize LIFF
        async function initializeLiff() {
            try {
                // Check if LIFF is available and configured
                if (typeof liff === 'undefined') {
                    console.log('LIFF not available - using demo mode');
                    currentUserId = 'demo_user_' + Date.now();
                    updateConnectionStatus();
                    return;
                }

                await liff.init({ liffId: "2007859046-doqQg8qv" });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                isLiffConnected = true;
                console.log("LINE user ID:", currentUserId);
                
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                // Use demo mode if LIFF fails
                currentUserId = 'demo_user_' + Date.now();
                console.log('Using demo mode with user ID:', currentUserId);
            }
            
            updateConnectionStatus();
        }

        // Screen navigation functions
        function showScreen(screenId) {
            const screens = ['homeScreen', 'cameraScreen', 'confirmScreen', 'resultScreen', 'successScreen', 'loadingScreen'];
            screens.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            hideError();
        }

        function goHome() {
            showScreen('homeScreen');
            resetCamera();
        }

        function openCamera() {
            showScreen('cameraScreen');
        }

        // Camera functions
        function handleImageCapture(event) {
            const file = event.target.files[0];
            if (file) {
                capturedImageFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const confirmImage = document.getElementById('confirmImage');
                    confirmImage.src = e.target.result;
                    showScreen('confirmScreen');
                };
                reader.readAsDataURL(file);
            }
        }

        function retakePhoto() {
            resetCamera();
            showScreen('cameraScreen');
        }

        function confirmAndSubmit() {
            if (!capturedImageFile) {
                showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á');
                return;
            }
            submitImage();
        }

        function resetCamera() {
            document.getElementById('cameraInput').value = '';
            document.getElementById('galleryInput').value = '';
            capturedImageFile = null;
        }

        // Submit image and process
        async function submitImage() {
            if (!capturedImageFile) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            showScreen('loadingScreen');

            try {
                const timestamp = Date.now();
                const userIdShort = currentUserId.substring(0, 8);
                const fileName = `food_${timestamp}_${userIdShort}.jpg`;
                
                if (isSupabaseConnected && supabase) {
                    console.log('Starting image upload to Supabase...');
                    console.log('File name:', fileName);
                    console.log('File size:', capturedImageFile.size);
                    console.log('File type:', capturedImageFile.type);
                    
                    // Check available buckets first
                    try {
                        const { data: buckets, error: bucketError } = await supabase.storage.listBuckets();
                        console.log('Available buckets:', buckets);
                        
                        if (bucketError) {
                            console.error('Cannot list buckets:', bucketError);
                            throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Supabase Storage ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key');
                        }
                        
                        const bucketExists = buckets && buckets.some(bucket => bucket.name === 'food_pics');
                        
                        if (!bucketExists) {
                            console.error('‚ùå Bucket "food_pics" not found');
                            console.log('üìã Available buckets:', buckets?.map(b => b.name) || 'None');
                            
                            // Show detailed error with instructions
                            const bucketNames = buckets?.map(b => b.name).join(', ') || '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                            throw new Error(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Storage Bucket "food_pics"
                            
üìã Buckets ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà: ${bucketNames}

üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:
1. ‡πÄ‡∏Ç‡πâ‡∏≤ Supabase Dashboard
2. ‡πÑ‡∏õ Storage > Create new bucket
3. ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠: food_pics
4. ‡πÄ‡∏õ‡∏¥‡∏î Public bucket
5. Save ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà

‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ bucket ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà`);
                        }
                        
                        console.log('‚úÖ Bucket "food_pics" found, proceeding with upload...');
                        
                    } catch (bucketErr) {
                        console.error('Storage access error:', bucketErr);
                        if (bucketErr.message.includes('‚ùå')) {
                            throw bucketErr; // Re-throw our custom error
                        }
                        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Supabase Storage ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
                    }
                    
                    // Try upload with multiple methods
                    let uploadData, uploadError;
                    
                    // Method 1: Standard upload
                    console.log('Attempting upload...');
                    const result = await supabase.storage
                        .from('food_pics')
                        .upload(fileName, capturedImageFile, {
                            cacheControl: '3600',
                            upsert: true
                        });
                    
                    uploadData = result.data;
                    uploadError = result.error;

                    if (uploadError) {
                        console.error('Upload failed:', uploadError);
                        
                        // Provide specific error messages
                        let errorMessage = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                        
                        if (uploadError.message?.includes('Bucket not found')) {
                            errorMessage = `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Storage Bucket "food_pics"
                            
üîß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á bucket ‡πÉ‡∏ô Supabase Dashboard:
1. ‡πÑ‡∏õ Storage > Create new bucket  
2. ‡∏ä‡∏∑‡πà‡∏≠: food_pics
3. ‡πÄ‡∏õ‡∏¥‡∏î Public bucket
4. Save ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà`;
                        } else if (uploadError.statusCode === 400) {
                            errorMessage = '‚ùå ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (JPEG, PNG)';
                        } else if (uploadError.statusCode === 403) {
                            errorMessage = `‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
                            
üîß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:
1. RLS Policy ‡πÉ‡∏ô Supabase
2. API Key ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
3. Bucket ‡πÄ‡∏õ‡πá‡∏ô Public`;
                        } else if (uploadError.statusCode === 413) {
                            errorMessage = '‚ùå ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÄ‡∏Å‡∏¥‡∏ô 5MB) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤';
                        } else if (uploadError.message) {
                            errorMessage = `‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${uploadError.message}`;
                        }
                        
                        throw new Error(errorMessage);
                    }

                    console.log('‚úÖ Upload successful:', uploadData);

                    // Get public URL
                    const { data: urlData } = supabase.storage
                        .from('food_pics')
                        .getPublicUrl(fileName);

                    console.log('üì∑ Public URL:', urlData.publicUrl);

                    // Save image info to database (graceful failure)
                    try {
                        const imageRecord = {
                            line_userid: currentUserId,
                            image_url: urlData.publicUrl,
                            file_name: fileName,
                            file_size: capturedImageFile.size,
                            mime_type: capturedImageFile.type,
                            created_at: new Date().toISOString()
                        };

                        console.log('üíæ Saving to database:', imageRecord);

                        const { data: dbData, error: dbError } = await supabase
                            .from('food_pics')
                            .insert([imageRecord])
                            .select();

                        if (dbError) {
                            console.error('‚ö†Ô∏è Database error:', dbError);
                            console.log('Image uploaded successfully but database save failed. Continuing...');
                        } else {
                            console.log('‚úÖ Database save successful:', dbData);
                        }
                    } catch (dbErr) {
                        console.error('‚ö†Ô∏è Database operation failed:', dbErr);
                        console.log('Image uploaded successfully but database save failed. Continuing...');
                    }
                    
                } else {
                    // Demo mode - simulate upload
                    console.log('üîß Demo mode: Simulating image upload for file:', fileName);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                // Simulate food recognition
                await simulateFoodRecognition();
                
                showScreen('resultScreen');
                displayFoodInfo();

            } catch (error) {
                console.error('‚ùå Error submitting image:', error);
                showError(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ');
                showScreen('confirmScreen');
            }
        }

        // Simulate food recognition and get data from database
        async function simulateFoodRecognition() {
            try {
                // In real implementation, you would use AI to recognize the food
                // For demo, we'll get a random food from the database
                const { data: foods, error } = await supabase
                    .from('meals_database')
                    .select('*')
                    .limit(1);

                if (error) throw error;

                if (foods && foods.length > 0) {
                    currentFoodData = foods[0];
                } else {
                    // Fallback sample data
                    currentFoodData = {
                        food_name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î‡∏Å‡∏∏‡πâ‡∏á',
                        calories: 450,
                        protein: 18,
                        carbs: 65,
                        fat: 12,
                        tip: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'
                    };
                }
            } catch (error) {
                console.error('Error getting food data:', error);
                // Use fallback data
                currentFoodData = {
                    food_name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                    calories: 300,
                    protein: 15,
                    carbs: 40,
                    fat: 10,
                    tip: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á'
                };
            }
        }

        // Display food information
        function displayFoodInfo() {
            if (!currentFoodData) return;

            const foodInfoDiv = document.getElementById('foodInfo');
            foodInfoDiv.innerHTML = `
                <div class="food-name">${currentFoodData.food_name}</div>
                <div class="nutrition-grid">
                    <div class="nutrition-item">
                        <div class="nutrition-label">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ</div>
                        <div class="nutrition-value">${currentFoodData.calories} kcal</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-label">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</div>
                        <div class="nutrition-value">${currentFoodData.protein} g</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-label">‡∏Ñ‡∏≤‡∏£‡πå‡∏ö</div>
                        <div class="nutrition-value">${currentFoodData.carbs} g</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-label">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</div>
                        <div class="nutrition-value">${currentFoodData.fat} g</div>
                    </div>
                </div>
                <div class="tip-section">
                    <div class="tip-label">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
                    <div class="tip-text">${currentFoodData.tip}</div>
                </div>
            `;
        }

        // Save to food log
        async function saveToLog() {
            if (!currentFoodData || !currentUserId) {
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                return;
            }

            showScreen('loadingScreen');

            try {
                const logData = {
                    line_userid: currentUserId,
                    date: new Date().toISOString().split('T')[0],
                    food_name: currentFoodData.food_name,
                    calories: currentFoodData.calories,
                    protein_g: currentFoodData.protein,
                    fat_g: currentFoodData.fat,
                    carbs_g: currentFoodData.carbs,
                    created_at: new Date().toISOString()
                };

                if (isSupabaseConnected && supabase) {
                    // Save to Supabase
                    const { data, error } = await supabase
                        .from('food_logs')
                        .insert([logData]);

                    if (error) throw error;
                    console.log('Data saved to Supabase successfully');
                } else {
                    // Demo mode - simulate save
                    console.log('Demo mode: Simulating data save:', logData);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate save delay
                }

                showScreen('successScreen');

            } catch (error) {
                console.error('Error saving to log:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                showScreen('resultScreen');
            }
        }

        // Error handling
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                hideError();
            }, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Initialize app when page loads
        window.addEventListener('load', () => {
            initializeSupabase();
            initializeLiff();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9759013ef6ebee25',t:'MTc1NjI3MDgyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
